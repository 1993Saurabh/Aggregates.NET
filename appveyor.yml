
cache:
  - src\packages
  
install:
  - cmd: ECHO "INSTALL:"
  - cmd: ECHO "APPVEYOR_REPO_COMMIT_MESSAGE ->"
  - cmd: ECHO %APPVEYOR_REPO_COMMIT_MESSAGE%
  - cmd: SET COMMIT_MSG="%APPVEYOR_REPO_COMMIT_MESSAGE%"
  - cmd: SET PUBLISH_BINARY=false
  # Check to verify the branch is the same than latest tag, if so
  # then we publish the binaries if everything else is successful.
  - cmd: git describe --tags --always HEAD > _git_tag.tmp
  - cmd: SET /p GIT_TAG=<_git_tag.tmp
  - cmd: ECHO "LATEST LOCAL TAG:"
  - cmd: ECHO %GIT_TAG%
  - cmd: ECHO "APPVEYOR REPO BRANCH/TAG:"
  - cmd: ECHO %APPVEYOR_REPO_BRANCH%
  - cmd: DEL _git_tag.tmp
  - cmd: IF x%APPVEYOR_REPO_BRANCH%==x%GIT_TAG% SET PUBLISH_BINARY=true
  # Or look for commit message containing `[publish binary]`
  - cmd: IF not x%COMMIT_MSG:[publish binary]=%==x%COMMIT_MSG% SET PUBLISH_BINARY=true
  - cmd: ECHO "Env Var PUBLISH_BINARY:"
  - cmd: ECHO %PUBLISH_BINARY%
  - cmd: SET VERSION="%GIT_TAG%.{build}"
  
assembly_info:
  patch: true
  file: src\SharedAssemblyInfo.*
  assembly_version: "%VERSION%"
  assembly_file_version: "%VERSION%"
  assembly_informational_version: "%VERSION%"

platform: Any CPU
configuration: Release


build_script:
  - ps: .\build.ps1
  
artifacts:
 - path: build\Aggregates.NET*.nupkg
   name: NuGet
 - path: build\Aggregates.NET.Binaries*.zip
   name: Binaries
 - path: build\Aggregates.NET.Source*.zip
   name: Source
   

deploy:
  - provider: Nuget
    release: "%VERSION%"
    auth_token:
      secure: nyYYvfNcljaFo6s6IBdC3lhqwAKOC9HfQjPguKXoHfgs22MwakH+IeXrM2Xn1uc0
    artifact: NuGet
    draft: false
    prerelease: true
    on:
      PUBLISH_BINARY: true
      branch: master
  - provider: GitHub
    release: "%VERSION%"
    auth_token:
      secure: E3k8jpbA+1HCY5PHHiUlaOTJVBSlJyGNUGdIAUTStkSs9Aw8b5jYJ8bMZv+9/nb+
    artifact: Binaries, Source
    draft: false
    prerelease: true
    on:
      PUBLISH_BINARY: true
      branch: master